# Partially signed multi signature transactions

## Abstract 
> You should have at minimum a basic understanding of how blockchain and multi-signature transactions work before proceeding. Multi-sig transactions are generated by asynchronously executing the newMultiSigTransaction() function while passing in the required parameters to produce a new multi-sig transaction. 

## `signPartialMultiSigTransaction()` parameters 

See the table below to get a better understanding of the parameters required. 

## Parameters
| Parameter name | Type | Required | Description | 
| :-------------: |:-------------:| :-------------:| :-------------:|
| `network` | String | Yes | The beyondcoin network specification. 
| `witnessScript` | String | Yes | The witness script associated with the multi-signature address funding this transaction.
| `keys` | Array | Yes | An array containing objects with the private keys, encoded in WIF format.
| `totalSignatures` | Number | Yes | The number of signatures required to execute this transaction.
| `utxo` | Array | Yes | An array containing objects with each UTXO used to fund this transaction.  

## Parameters explained 

### `network`
The `network` parameter can be set as either `normal` for live network transactions or as `testnet` for testnet based transactions. 

### `witnessScript` 
The witness script is the unique result of all the public keys associated with the multi-signature address, it is commonly created and saved when the multi-signature address is generated or derived.

### `keys`
In this library, each private key to the multi-signature address funding a transaction is encoded as a WIF, also known as the Wallet Import Format. The `keys` array is made up of string type properties each containing a WIF.

### `totalSignatures`
The signatures property assists in identifying the number of signatures required to execute the transaction, i.e broadcast to the Beyondcoin network. This property is actually determined at the time the multi-signature address is created but still must be correctly passed to the `signPartialMultiSigTransaction()` function.

### `utxo`
This is also known as unspent transaction outputs. In this library, the `utxo` is an array containing objects defining each unspent output to be used for this transaction. The objects contain a number of properties, see below. 

#### `utxo` object parameters 
The transaction ID corresponding with the unspent output. 

| Parameter name | Type | Description
| :-------------: |:-------------:| :-------------:| 
| `txid` | String | The unique transaction ID of a UTXO.   
| `index` | String | The index value of this UTXO.  
| `amount` | Number | The amount of beyondcoin present at this UTXO **IN LITOSHI** formatting.

# Considerations

## Signatures
The `totalSignatures` property is required for guidance only. For example, if the multi-signature address was generated in a way that requires 3 of 5 keys but you set the signatures property as 2 keys when building a transaction, the transaction will still require 3 of 5 keys, since the "transaction" is being spent from a multi-signature address that was generated requiring 3 of 5 days.

The `totalSignatures` property passed to `signPartialMultiSigTransaction()` has no influence on the actual signatures required to execute a transaction, at this point it's required to assist with internal functionality when transferring partially signed transactions. 

This property will likely be removed in the future. 

## Verification
The transaction inputs, outputs and the network fee should be carefully reviewed. It's possible to review a partial transaction manually by deconstructing it (no documentation on this yet) or using a helper function like `viewPartialMultiSigTransaction()` to assist. 

# Creating a PSMST 
## Generate a multi-signature address set 

For demo purposes, create a multi-signature testnet address set, see below.

```
await beyondcoinjs.newMultiSigAddressSet(5, 3, 'testnet').then((result) =>{
	console.log(result);
})
```

This will produce a multi-signature address set that requires any 3 of the 5 private keys to execute a spend from this address, see response below.

```
{ master: 'QhzqTwQ6Ky8UmBuPtFHNb4iTxrDvirzcah',
  witnessScript: '5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae',
  keys: 
   [ { wif: 'cW71MiTEQ4kV4BDsrr9LykeAjF6whUJVevi79kcx4fTii9RXpbBz',
       publicKey: '026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de62',
       index: 0 },
     { wif: 'cSFoQ5bwwFBJ6VgA4v5wAeQjLxEP891ceECoFGBKhLNVQ5sPpwWw',
       publicKey: '02ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f80',
       index: 1 },
     { wif: 'cNTbBWXpZZTUiZx19AwMY23wtUvbDUczfTPTrom2KLkbQnKUXzRk',
       publicKey: '03d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f54',
       index: 2 },
     { wif: 'cUzF39y8C437apsqMjLuP1HGXNEpWDJNUQLWvAWPtv4y6ZioRKY4',
       publicKey: '027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c35',
       index: 3 },
     { wif: 'cSVqKPRgF8SAin3ccUPNKkufRAW6dyaSaK7MeqJAXPspvsRswRjA',
       publicKey: '03de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de00',
       index: 4 } ] }
```

## Initialize transaction with `newMultiSigTransaction()`

Initialize the transaction using `newMultiSigTransaction()` -- for demo purposes, consume two UTXOs each with a value of 100,000,000 litoshi and send to 2 different addresses with a total transaction fee of 25,000 litoshi. Sign this transaction using only one key.
```
  await beyondcoinjs.newMultiSigTransaction({
    network: 'testnet',
    witnessScript: '5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae',
    keys: ['cW71MiTEQ4kV4BDsrr9LykeAjF6whUJVevi79kcx4fTii9RXpbBz'],
    signatures: 3,
    utxo: [
      {
        txid: 'c1cf5f512194f7fe9af4b11b5cd1357fdb13621099630e9d579491509c1bb288',
        index: 0,
        amount: 100000000 // unspent amount
      },
      {
        txid: '3418683a808116ffd9f3eafc23918fcdfd4c28fd9c6ecf37d81a77e56e3c0255',
        index: 1,
        amount: 100000000 // unspent amount
      }],
    output: [
      {
        address: 'QihYZTTzDtKFEy2sGJDbAToLbnRRuzmA8r',
        amount: 199675000
      },
      {
        address: 'mqZgkq6ikqYW1Bp4SGcA57cznwTNMkDyzr',
        amount: 300000
      }],
    fee: 25000 // transaction fee
  }).then((result) => {
    console.log(result)
  })
```
The entire response is now safe to hand over to the next signee. The response will contain a number of properties, see table below. 

| Parameter name | Type | Description
| :-------------: |:-------------:| :-------------:| 
| `rawTransaction` | String | The raw transaction in HEX formatting.   
| `utxo` | Array | A utxo set consisting of the `txid`, `index` and `value`. **This must be in the same order as when the transaction was initialized with `newMultiSigTransaction()`.**
| `totalSignatures` | Number | The **total** number of signatures required for this transaction.
| `pendingSignatures` | Number | The total number of **remaining** signatures required for this transaction.
| `state` | String | This will be 'complete' or 'incomplete' depending on the state of the transaction.

See the response example below.
```
{ rawTransaction: '0100000000010288b21b9c509194579d0e6399106213db7f35d15c1bb1f49afef79421515fcfc1000000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff55023c6ee5771ad837cf6e9cfd284cfdcd8f9123fceaf3d9ff1681803a681834010000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff0278cce60b0000000017a914f25fef8faaf3076a9f42cc0abbbe71eeb884660087e0930400000000001976a9146e3588f39d65abd8540f01096b9f565a0baf9bff88ac070047304402200b883649f1425b9275016134a415aa1a8af756bf56585624e6f07a6a937bcea4022070130b16e00666402ad14cdd1cce41f937f628166e90ccf62efad767501f1e7e0100000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae070047304402201da5b0402c7b21d2edade5ac688ba7eb2f076ada2e295d85b81c4275e26f53f30220439dd087579b07b74a1f1d4e6a29b99662e3a7a2e42415656bd937ac8730178f0100000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae00000000',
  utxo: 
   [ { txid: 'c1cf5f512194f7fe9af4b11b5cd1357fdb13621099630e9d579491509c1bb288',
       index: 0,
       amount: 100000000 },
     { txid: '3418683a808116ffd9f3eafc23918fcdfd4c28fd9c6ecf37d81a77e56e3c0255',
       index: 1,
       amount: 100000000 } ],
  totalSignatures: 3,
  pendingSignatures: 2,
  state: 'incomplete' }
```

The response above is then passed to the next signee. 

## Sign transaction with `signPartialMultiSigTransaction()`

The second signee can now sign the transaction using the information from the first initialized transaction (see above), using the previous `rawTransaction`, along with the other details, see below. The signee sets their private key in the `key` array as a string type property.
```
   await beyondcoinjs.signPartialMultiSigTransaction({
      network: 'testnet',
      rawTransaction: '0100000000010288b21b9c509194579d0e6399106213db7f35d15c1bb1f49afef79421515fcfc1000000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff55023c6ee5771ad837cf6e9cfd284cfdcd8f9123fceaf3d9ff1681803a681834010000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff0278cce60b0000000017a914f25fef8faaf3076a9f42cc0abbbe71eeb884660087e0930400000000001976a9146e3588f39d65abd8540f01096b9f565a0baf9bff88ac070047304402200b883649f1425b9275016134a415aa1a8af756bf56585624e6f07a6a937bcea4022070130b16e00666402ad14cdd1cce41f937f628166e90ccf62efad767501f1e7e0100000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae070047304402201da5b0402c7b21d2edade5ac688ba7eb2f076ada2e295d85b81c4275e26f53f30220439dd087579b07b74a1f1d4e6a29b99662e3a7a2e42415656bd937ac8730178f0100000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae00000000',
      witnessScript: '5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae',
      keys: ['cSFoQ5bwwFBJ6VgA4v5wAeQjLxEP891ceECoFGBKhLNVQ5sPpwWw'],
      utxo: [
      {
         txid: 'c1cf5f512194f7fe9af4b11b5cd1357fdb13621099630e9d579491509c1bb288',
         index: 0,
         amount: 100000000 // unspent amount
      },
      {
         txid: '3418683a808116ffd9f3eafc23918fcdfd4c28fd9c6ecf37d81a77e56e3c0255',
         index: 0,
         amount: 100000000 // unspent amount
      }],
      totalSignatures: 3
   }).then((result) =>{
      console.log(result);
   })
```
The response should indicate that the transaction is still incomplete and the `pendingSignatures` should be 1, since the transaction at this point only has 2 of the minimum 3 required signatures. The next signee is now ready to sign using the information from the response below.  
```
{ rawTransaction: '0100000000010288b21b9c509194579d0e6399106213db7f35d15c1bb1f49afef79421515fcfc1000000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff55023c6ee5771ad837cf6e9cfd284cfdcd8f9123fceaf3d9ff1681803a681834010000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff0278cce60b0000000017a914f25fef8faaf3076a9f42cc0abbbe71eeb884660087e0930400000000001976a9146e3588f39d65abd8540f01096b9f565a0baf9bff88ac070047304402200b883649f1425b9275016134a415aa1a8af756bf56585624e6f07a6a937bcea4022070130b16e00666402ad14cdd1cce41f937f628166e90ccf62efad767501f1e7e01473044022079181c1df3f7b80a5ea4f0ff7cd6af73d37c886f46022d125f7f652dbacb6e720220052bc9b0bd8a8369d2b971185fc40dac6cbba39d2497ceea0d03433cf500fff401000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae070047304402201da5b0402c7b21d2edade5ac688ba7eb2f076ada2e295d85b81c4275e26f53f30220439dd087579b07b74a1f1d4e6a29b99662e3a7a2e42415656bd937ac8730178f01473044022039f077ce37fe9e52e8b2564ee8ad140ac1a43766d4fe6704d559973873ac37ec022008500cbd0f62315257fa03172d1cd2b4bbdac29486c0849832711f96b323e19401000000ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae00000000',
  utxo: 
   [ { txid: 'c1cf5f512194f7fe9af4b11b5cd1357fdb13621099630e9d579491509c1bb288',
       index: 0,
       amount: 100000000 },
     { txid: '3418683a808116ffd9f3eafc23918fcdfd4c28fd9c6ecf37d81a77e56e3c0255',
       index: 0,
       amount: 100000000 } ],
  totalSignatures: 3,
  pendingSignatures: 1,
  state: 'incomplete' }
```

## Final signature with `signPartialMultiSigTransaction()`
The third and final signee can now sign the transaction using the information provided by the second signee. The third signee will be using the previous `rawTransaction`, along with the other details, see below. The signee sets their private key in the key array as a string type property.

```
{ rawTransaction: '0100000000010288b21b9c509194579d0e6399106213db7f35d15c1bb1f49afef79421515fcfc1000000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff55023c6ee5771ad837cf6e9cfd284cfdcd8f9123fceaf3d9ff1681803a681834010000002322002002261759eb63cb68e7a2648b2493aff5219986f38f1458e5957924062bd60f9bffffffff0278cce60b0000000017a914f25fef8faaf3076a9f42cc0abbbe71eeb884660087e0930400000000001976a9146e3588f39d65abd8540f01096b9f565a0baf9bff88ac050047304402200b883649f1425b9275016134a415aa1a8af756bf56585624e6f07a6a937bcea4022070130b16e00666402ad14cdd1cce41f937f628166e90ccf62efad767501f1e7e01473044022079181c1df3f7b80a5ea4f0ff7cd6af73d37c886f46022d125f7f652dbacb6e720220052bc9b0bd8a8369d2b971185fc40dac6cbba39d2497ceea0d03433cf500fff401483045022100cd36fb71720f900fa4a2d187525bb8916cc109a48d4ea87dea68569b909440b2022008221f711954e856d6dc235b8fa51e2d27fcb9e05223d6725f1930bb6e51335801ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae050047304402201da5b0402c7b21d2edade5ac688ba7eb2f076ada2e295d85b81c4275e26f53f30220439dd087579b07b74a1f1d4e6a29b99662e3a7a2e42415656bd937ac8730178f01473044022039f077ce37fe9e52e8b2564ee8ad140ac1a43766d4fe6704d559973873ac37ec022008500cbd0f62315257fa03172d1cd2b4bbdac29486c0849832711f96b323e1940147304402204bcedd1b85a42a32464929452e58d20c541066f5b80c1ed65f33b7aec248b13c02200c64d7d41882faa869c1babe9378b8ea7059b751d02c81d5dffff8e069ab294001ad5321026c28fbb59ed148f15cbc5d97edecb0cbd120e809a525435c72c2426e4b74de622102ce90c5969d7ffb8cd3084aa997ba6735fb1a6420d098cf34a347fb9531719f802103d5d124feb096eef3e75493a88f9ae0bca91cec563d591c67b8f9001fba8c6f5421027084c8c800bf152dcc8090abcd5c51f2cba709b36c8f26b7a40cbac55dd68c352103de7780348faa72372ea5ee9b5dfcdb081e41c651431a34464327d39c6c02de0055ae00000000',
  state: 'complete' }
```

The transaction is now complete and ready to be broadcasted to the Beyondcoin network, using the `rawTransaction` property.

The above example was real and confirmed on the testnet Beyondcoin network as TXID `ab382759bd8d6404b95658478473b53572d9c332b2fc54d5687c02763eb4e4f0`.

More examples coming soon.
